<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<link rel="shortcut icon" href="#">
<style>
    #background {
        background-image: url("https://cdn.pixabay.com/photo/2020/03/21/17/26/woman-4954694_1280.jpg");
    }
</style>
<th:block th:replace="/layout/fragments/head :: headFragment"></th:block>
<body>
<div id="wrapper">
    <header class="bg-gradient-dark">
        <th:block th:replace="/layout/fragments/navbar :: navbarFragment"></th:block>

        <div class="page-header min-vh-65" id="background">
            <span class="mask bg-gradient-dark opacity-6"></span>
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-lg-8 text-center mx-auto my-auto">
                        <h1 class="text-white">λ‚μ μ¥λ°”κµ¬λ‹</h1>
                        <p class="lead mb-4 text-white opacity-8">ν¬μΈνΈλ΅ μκ°•κ¶μ„ κµ¬λ§¤ν•μ—¬ κ°λ° μ§€μ‹μ„ ν‚¤μ›λ‚κ°€μ„Έμ”!</p>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <input type="hidden" th:value="${session.loginEmail}" id="memberEmail">
    <input type="hidden" th:value="${session.loginId}" id="memberId">

    <div th:if="${cartCheck}" class="row">
        <div class="card card-body blur shadow-blur mx-1 mx-md-1 mt-n3">
        <a href="/onClass/" class="h3">μ•„μ§ μ¥λ°”κµ¬λ‹μ— λ‹΄μ€ κ°•μκ°€ μ—†μ–΄μ”π¤Έβ€β™‚</a>
        </div>
    </div>

    <div class="row" th:unless="${cartCheck}">
        <div class="col-lg-8">
            <div class="card card-body blur shadow-blur mx-1 mx-md-1 mt-n3">

                <div id="cartLength" class="row">
                    <form action="/onClass/payment" method="post" id="payment">
                        <div class="col-md-3 mb-5" th:each="cart:${cartList}">
                            <div class="card h-100">
                                <a th:href="@{|/onClass/${cart.onClassId}|}">

                                    <input type="hidden" th:value="${cart.onClassId}" name="onClassId">

                                    <div class="card-body">
                                        <p class="card-text text-center">
                                            <img class="img-fluid rounded mb-4 mb-lg-0"
                                                 th:src="@{/class_upload/}+${cart.onClassFileName}"
                                                 alt="..." width="150" height="100"/></p>
                                        <p class="card-text text-center h6" th:text="${cart.onClassTitle}"></p>
                                    </div>
                                </a>
                                <div class="card-footer text-center">
                                    <span class="card-text" id="onClassPrice" th:text="${cart.onClassPrice}"></span>
                                    <span>point</span>
                                </div>
                                <button type="button" class="btn btn-danger btn-sm"
                                        th:onclick="deleteById([[${cart.cartId}]])">μ¥λ°”κµ¬λ‹μ—μ„ μ‚­μ 
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card card-body blur shadow-blur mx-1 mx-md-1 mt-n3">
                <div class="h4">μ΄κ³„ : &#8361;<span th:text="*{totalPrice}" th:value="*{totalPrice}"></span></div>
                <div class="h6">ν¬μΈνΈ μ‚¬μ© :<input class="form-control" type="number" min="0" th:max="*{memberPoint}"
                                               id="point_use_value" name="pointUse" onblur="point_use()" value="0">
                    <span th:text="*{'λ³΄μ  ν¬μΈνΈ : '+memberPoint +'point'}"></span>
                </div>
                <span class="h6" id="pointApply"></span>
                <div class="h3"> κ²°μ κΈμ•΅ : <span id="applyPrice" th:text="*{totalPrice}"></span></div>
                <input type="hidden" id="point_value" value="0">
                <input type="hidden" id="totalPrice" th:value="*{totalPrice}">
                <input type="hidden" id="applyValue" th:value="*{totalPrice}">
                <button type="button" class="btn btn-success" onclick="requestPay()" value="μκ°•κ¶ κµ¬λ§¤">μκ°•κ¶ κµ¬λ§¤</button>
            </div>
        </div>
    </div>
</div>
<th:block th:replace="/layout/fragments/script :: scriptFragment"></th:block>
</body>
<script>
    function deleteById(cartId) {
        const reqUrl = "/cart/" + cartId;
        $.ajax({
            url: reqUrl,
            type: 'delete',
            success: function () {
                alert('μ‚­μ λμ—μµλ‹λ‹¤.')
                location.reload();
            }, error: function () {
                alert('μ”μ²­μ‹¤ν¨')
            }
        });
    }
</script>
<script>
    const point_use = () => {
        const maxPoint = '[[${memberPoint}]]'
        const point = document.getElementById('point_use_value');
        const intPoint = parseInt(point.value);
        //μ΄κΈ° κ°’
        const startPrice = document.getElementById('totalPrice').value;
        const applyPrice = document.getElementById('applyPrice');

        console.log(intPoint + "<" + maxPoint);
        if (intPoint < maxPoint && intPoint <= startPrice) {
            // ν¬μΈνΈκ°€ μ μ©λ κ°’
            const view = document.getElementById('pointApply');
            document.getElementById('point_value').value = intPoint;

            let finalInt = startPrice - intPoint;
            applyPrice.innerHTML = `${finalInt} μ›`;
            view.innerHTML = `${startPrice}μ› - ${intPoint}point μ‚¬μ©`;
            $('#applyValue').val(finalInt);

        } else if (intPoint > maxPoint) {
            alert(`λ³΄μ  ν¬μΈνΈ(${maxPoint})λ¥Ό μ΄κ³Όν•μ€μµλ‹λ‹¤.`);
        } else if(intPoint == 0){
            $('#applyValue').val(startPrice);
            applyPrice.innerHTML = `${startPrice} μ›`;
        }
        else {
            alert('κ²°μ  κΈμ•΅μ„ μ΄κ³Όν•μ€μµλ‹λ‹¤.');
        }
    }
</script>
<script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
<script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.1.5.js"></script>
<script th:inline="javascript">
    //κµ¬λ§¤ κ°’κ³Ό κµ¬λ§¤μμ μ΄λ©”μΌ

    const memberEmail = document.querySelector("#memberEmail").value;
    const memberId = document.querySelector("#memberId").value;


    const IMP = window.IMP;
    IMP.init('imp45182196');

    console.log(memberEmail);

    function requestPay() {
        //κ²°μ ν•  κΈμ•΅
        const applyPrice = parseInt(document.querySelector("#applyValue").value);
        //μ‚¬μ©ν• ν¬μΈνΈ
        const pointPoint = parseInt(document.getElementById('point_use_value').value);

        const form = document.getElementById("payment");


        // IMP.request_pay(param, callback) κ²°μ μ°½ νΈμ¶
        IMP.request_pay({ // param
            pg: "kakao",
            pay_method: "card",
            merchant_uid: 'merchant_' + new Date().getTime(),
            name: "μκ°•κ¶ κµ¬λ§¤",
            amount: applyPrice,
            buyer_email: memberEmail

        }, function (rsp) { // callback
            //κ²°μ κΈμ•΅μ΄ 0μΌ λ•
            if(applyPrice == 0){
                rsp.success = true;
            }
            if (rsp.success) {
                form.submit();
                alert('κ²°μ κ°€ μ™„λ£λμ—μµλ‹λ‹¤.');
                const pointUrl = "/onClass/pointPayment"
                $.ajax({
                    type: 'post',
                    url: pointUrl,
                    data: {
                        "memberId": memberId,
                        "pointPoint": pointPoint
                    },
                    success: function () {
                    },
                    error: function () {
                        alert('ajax μ‹¤ν¨');
                    }
                });

            } else {
                const msg = 'κ²°μ μ— μ‹¤ν¨ν•μ€μµλ‹λ‹¤.';
                alert(msg);
            }


        });
    };
</script>
</html>